
<!DOCTYPE html> 
<title>Video/Canvas Demo 2</title> 
<script>
///TODO////
//caricare due video diversi invece dello stesso2

//gestire N video caricati da js, invece di due video hardcodati
//avere una funzione playVideo(idVideo)
//escludere audio dalla riproduzione del video
//streaming audio?
//potrei fare una demo prendendo due video in due versioni diverse, esempio
	//video ufficiale canzone o clip fan
//full screen

/////NOTE/////
//se far partire un video richiede troppo, 
	//posso inizializzare tutti i video facendoli pre-partire per un secondo
	//in aggiunta, o in alternativa, verifico il loro stato di buffering

//gestione del flusso, possibilita:
	//video partono in contemporanea e si switcha
	//video parte quando schiaccio un pulsante
	//video parte, di default, al termine di quello prima
	//considerare integrazione con pulsanti in canvas
//  penso che questa debba essere deciso con condice ad hoc, a meno di fare un bel lavoraccio...

// per runnare il server: lighttpd -f ./lighttpd.conf dalla dir del file. porta 3000

var idVideoToPlay = 1;

var videoIds = ['video1', 'video2'];

var v = document.getElementById('video1');
	var v2 = null;
	var canvas = null;
	var context = null;
	var back = null;
	var backcontext = null;
 
	var cw,ch;

document.addEventListener('DOMContentLoaded', function(){
	v = document.getElementById('video1');
	v2 = document.getElementById('video2');
	canvas = document.getElementById('c');
	context = canvas.getContext('2d');
	back = document.createElement('canvas');
	backcontext = back.getContext('2d');
 
	cw,ch;

 
},false);

function startDrawingVideo(v){
		cw = v.clientWidth;
		ch = v.clientHeight;
		canvas.width = 300;
		canvas.height = 300;
		back.width = 300;
		back.height = 300;
		draw(v,context,backcontext,300,300);
}

var switchToVideo = null;

function draw(v,c,bc,w,h) {
	if (switchToVideo) {
		v = switchToVideo;
		switchVideo = null;
	}

	//if(v.paused || v.ended)	return false;

	// First, draw it into the backing canvas
	bc.drawImage(v,0,0,w,h);

	// Grab the pixel data from the backing canvas
	var idata = bc.getImageData(0,0,w,h);
	var data = idata.data;

	idata.data = data;
	// Draw the pixels onto the visible canvas
	c.putImageData(idata,0,0);
	// Start over!
	setTimeout(draw,20,v,c,bc,w,h);
}

function startVideos(){
	currentVideoId = 0;
	var videoToStartId = videoIds[currentVideoId];
	var videoElement = document.getElementById(videoToStartId);
	videoElement.play();
	startDrawingVideo(videoElement);
}

var currentVideoId = null;

function changeVideoToDraw(video) {
	switchToVideo = video;
}

function toggleVideo() {
	currentVideoId = (currentVideoId + 1) % videoIds.length;

	var videoToPlay = document.getElementById(videoIds[currentVideoId]);

	videoToPlay.play();

	changeVideoToDraw(videoToPlay);
}

function bindButtons() {
	var toggleButton = document.getElementById('toggleButton');
	var startButton = document.getElementById('startButton');

	toggleButton.addEventListener('click', toggleVideo);
	startButton.addEventListener('click', startVideos);
}

</script> 
 
<body>
<a id="startButton">Start Video</a>
<a id="toggleButton">Toggle Video</a>

<video id="video1"> 
	<source src=video.webm type=video/webm> 
	<source src=video.ogg type=video/ogg> 
	<source src=video.mp4 type=video/mp4> 
</video>

<video id="video2"> 
	<source src=video.webm type=video/webm> 
	<source src=video.ogg type=video/ogg> 
	<source src=video.mp4 type=video/mp4> 
</video>

<canvas id="c"></canvas> 


 
<style> 
#c {
	
}
 
#v {
	
}

#video1, #video2 {
	width: 0px;
	display: block;
}
</style>

<script>
bindButtons();
</script>
</body>
</html>
