
<!DOCTYPE html> 
<title>Video/Canvas Demo 2</title> 
<script> 
//caricare due video diversi invece dello stesso
//mettere i controlli fuori dal canvas
//pausare i video e farli partire quando si switchano, invece di farli andare sempre
//gestire N video caricati da js, invece di due video hardcodati
//avere una funzione playVideo(video)
//streaming audio?
//potrei fare una demo prendendo due video in due versioni diverse, esempio
	//video ufficiale canzone o clip fan
//full screen
// per runnare il server: lighttpd -f ./lighttpd.conf dalla dir del file. porta 3000
var idVideoToPlay = 1;

var videoIds = ['video1', 'video2'];

var v = document.getElementById('video1');
	var v2 = null;
	var canvas = null;
	var context = null;
	var back = null;
	var backcontext = null;
 
	var cw,ch;

document.addEventListener('DOMContentLoaded', function(){
	v = document.getElementById('video1');
	v2 = document.getElementById('video2');
	canvas = document.getElementById('c');
	context = canvas.getContext('2d');
	back = document.createElement('canvas');
	backcontext = back.getContext('2d');
 
	cw,ch;

 
},false);

function startDrawingVideo(v){
		cw = v.clientWidth;
		ch = v.clientHeight;
		canvas.width = 300;
		canvas.height = 300;
		back.width = 300;
		back.height = 300;
		draw(v,context,backcontext,300,300);
}

var switchToVideo = null;

function draw(v,c,bc,w,h) {
	if (switchToVideo) {
		v = switchToVideo;
		switchVideo = null;
	}

	//if(v.paused || v.ended)	return false;

	// First, draw it into the backing canvas
	bc.drawImage(v,0,0,w,h);

	// Grab the pixel data from the backing canvas
	var idata = bc.getImageData(0,0,w,h);
	var data = idata.data;

	// Loop through the pixels, turning them grayscale
	for(var i = 0; i < data.length; i+=4) {
		var r = data[i];
		var g = data[i+1];
		var b = data[i+2];
		var brightness = (3*r+4*g+b)>>>3;
		data[i] = brightness;
		data[i+1] = brightness;
		data[i+2] = brightness;
	}
	idata.data = data;
	// Draw the pixels onto the visible canvas
	c.putImageData(idata,0,0);
	// Start over!
	setTimeout(draw,20,v,c,bc,w,h);
}

function startVideos(){
	currentVideoId = 0;
	var videoToStartId = videoIds[currentVideoId];
	var videoElement = document.getElementById(videoToStartId);
	videoElement.play();
	startDrawingVideo(videoElement);
}

var currentVideoId = null;

function changeVideoToDraw(video) {
	switchToVideo = video;
}

function toggleVideo() {
	currentVideoId = (currentVideoId + 1) % videoIds.length;

	var videoToPlay = document.getElementById(videoIds[currentVideoId]);

	videoToPlay.play();

	changeVideoToDraw(videoToPlay);
}

</script> 
 

 
<video id="video1"> 
	<source src=video.webm type=video/webm> 
	<source src=video.ogg type=video/ogg> 
	<source src=video.mp4 type=video/mp4> 
</video>

<video id="video2"> 
	<source src=video.webm type=video/webm> 
	<source src=video.ogg type=video/ogg> 
	<source src=video.mp4 type=video/mp4> 
</video>

<canvas id="c"></canvas> 
 
<style> 
#c {
	
}
 
#v {
	
}

#video1, #video2 {
	width: 0px;
}
</style> 